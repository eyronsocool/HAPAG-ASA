<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Profile - HAPAG-ASA</title>
  <link rel="stylesheet" href="profile.css">
  
</head>
<body>
  <header>
    <nav>
      <a href="home.html" class="logo">
        <div class="logo-icon">üç≤</div>
        <span>HAPAG-ASA</span>
      </a>
      <ul class="nav-links">
        <li><a href="home.html">HOME</a></li>
        <li><a href="program.html">PROGRAMS</a></li>
        <li><a href="about.html">ABOUT</a></li>
        <li>
          <a href="profile.html" class="nav-profile active" aria-label="Profile">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
              <circle cx="12" cy="8" r="3" stroke="currentColor" stroke-width="1.5" fill="none" />
              <path d="M4 20c0-4 4-6 8-6s8 2 8 6" stroke="currentColor" stroke-width="1.5" fill="none" stroke-linecap="round" />
            </svg>
          </a>
        </li>
      </ul>
    </nav>
  </header>

  <div class="profile-container">
    <div class="profile-card">
      <div class="profile-header">
        <div class="profile-icon">üë§</div>
        <div>
          <h1 class="profile-title">User Profile</h1>
          <p class="profile-subtitle">Complete your profile for program applications</p>
        </div>
      </div>

      <div id="successMessage" class="message success-message"></div>
      <div id="errorMessage" class="message error-message"></div>
      <div id="infoMessage" class="message info-message"></div>

      <form id="profileForm">
        <!-- Personal Information -->
        <div class="form-section">
          <h2 class="section-title">üìã Personal Information</h2>
          
          <div class="form-row">
            <div class="form-group">
              <label for="firstName">First Name <span class="required">*</span></label>
              <input type="text" id="firstName" required />
            </div>

            <div class="form-group">
              <label for="lastName">Last Name <span class="required">*</span></label>
              <input type="text" id="lastName" required />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="birthdate">Birthdate <span class="required">*</span></label>
              <input type="date" id="birthdate" required />
            </div>

            <div class="form-group">
              <label for="gender">Gender <span class="required">*</span></label>
              <select id="gender" required>
                <option value="">Select Gender</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label for="phone">Phone Number <span class="required">*</span></label>
            <input type="tel" id="phone" placeholder="09XX XXX XXXX" required />
          </div>
        </div>

        <!-- Address Information -->
        <div class="form-section">
          <h2 class="section-title">üìç Address Information</h2>
          
          <div class="form-group">
            <label for="barangay">Barangay <span class="required">*</span></label>
            <select id="barangay" required>
              <option value="">Select Barangay</option>
              <option value="Barretto">Barretto</option>
              <option value="Gordon Heights">Gordon Heights</option>
              <option value="Mabayuan">Mabayuan</option>
            </select>
          </div>

          <div class="form-group">
            <label for="address">Complete Address <span class="required">*</span></label>
            <textarea id="address" placeholder="House/Block/Lot No., Street Name" required></textarea>
          </div>
        </div>

        <!-- Household Information -->
        <div class="form-section">
          <h2 class="section-title">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Household Information</h2>
          
          <div class="form-row">
            <div class="form-group">
              <label for="householdSize">Household Size</label>
              <input type="number" id="householdSize" min="1" placeholder="Number of family members" />
            </div>

            <div class="form-group">
              <label for="monthlyIncome">Monthly Household Income</label>
              <select id="monthlyIncome">
                <option value="">Select Range</option>
                <option value="Below 5000">Below ‚Ç±5,000</option>
                <option value="5000-10000">‚Ç±5,000 - ‚Ç±10,000</option>
                <option value="10000-15000">‚Ç±10,000 - ‚Ç±15,000</option>
                <option value="15000-20000">‚Ç±15,000 - ‚Ç±20,000</option>
                <option value="Above 20000">Above ‚Ç±20,000</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Additional Information -->
        <div class="form-section">
          <h2 class="section-title">üìù Additional Information</h2>
          
          <div class="form-group">
            <label for="specialNeeds">Special Needs or Circumstances (Optional)</label>
            <textarea id="specialNeeds" placeholder="Any special circumstances we should know about..."></textarea>
          </div>
        </div>

        <button type="submit" class="btn-primary" id="saveBtn">
          üíæ Save Profile
        </button>
      </form>

      <button class="logout-btn" onclick="handleLogout()" style="margin-top: 2rem;">
        üö™ Logout
      </button>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAraqQhEWlLxUP_XTOTZlgN7CAQOkuZbp8",
      authDomain: "hapag-asa.firebaseapp.com",
      projectId: "hapag-asa",
      storageBucket: "hapag-asa.appspot.com",
      messagingSenderId: "533177839171",
      appId: "1:533177839171:web:4cd74f4949f2449b09eef6"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let currentUser = null;

    // Check authentication and load profile
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        await loadUserProfile(user.uid);
      } else {
        window.location.href = 'login.html';
      }
    });

    // Load existing profile data
    async function loadUserProfile(uid) {
      try {
        const doc = await db.collection("userProfiles").doc(uid).get();
        
        if (doc.exists) {
          const data = doc.data();
          
          // Fill form with existing data
          document.getElementById('firstName').value = data.firstName || '';
          document.getElementById('lastName').value = data.lastName || '';
          document.getElementById('birthdate').value = data.birthdate || '';
          document.getElementById('gender').value = data.gender || '';
          document.getElementById('phone').value = data.phone || '';
          document.getElementById('barangay').value = data.barangay || '';
          document.getElementById('address').value = data.address || '';
          document.getElementById('householdSize').value = data.householdSize || '';
          document.getElementById('monthlyIncome').value = data.monthlyIncome || '';
          document.getElementById('specialNeeds').value = data.specialNeeds || '';
          
          showInfo('Profile loaded successfully!');
        }
      } catch (error) {
        console.error('Error loading profile:', error);
        showError('Could not load existing profile data.');
      }
    }

    // Save profile data
    document.getElementById("profileForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      if (!currentUser) {
        showError("You must be logged in to save your profile.");
        return;
      }

      const saveBtn = document.getElementById('saveBtn');
      const originalText = saveBtn.innerHTML;
      saveBtn.disabled = true;
      saveBtn.innerHTML = '<span class="loading"></span> Saving...';

      const profileData = {
        firstName: document.getElementById("firstName").value.trim(),
        lastName: document.getElementById("lastName").value.trim(),
        fullName: `${document.getElementById("firstName").value.trim()} ${document.getElementById("lastName").value.trim()}`,
        birthdate: document.getElementById("birthdate").value,
        gender: document.getElementById("gender").value,
        phone: document.getElementById("phone").value.trim(),
        barangay: document.getElementById("barangay").value,
        address: document.getElementById("address").value.trim(),
        householdSize: document.getElementById("householdSize").value,
        monthlyIncome: document.getElementById("monthlyIncome").value,
        specialNeeds: document.getElementById("specialNeeds").value.trim(),
        email: currentUser.email,
        uid: currentUser.uid,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        profileComplete: true
      };

      try {
        await db.collection("userProfiles").doc(currentUser.uid).set(profileData, { merge: true });
        
        showSuccess("‚úÖ Profile saved successfully! You can now apply for programs.");
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalText;
        
        // Scroll to top to show success message
        window.scrollTo({ top: 0, behavior: 'smooth' });
      } catch (error) {
        console.error('Error saving profile:', error);
        showError("‚ùå Error saving profile: " + error.message);
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalText;
      }
    });

    // Application submission function (to be called from program pages)
    async function submitApplication(programName, programId) {
      if (!currentUser) {
        alert('Please login first');
        window.location.href = 'login.html';
        return;
      }

      try {
        // Check if profile is complete
        const profileDoc = await db.collection("userProfiles").doc(currentUser.uid).get();
        
        if (!profileDoc.exists || !profileDoc.data().profileComplete) {
          alert('Please complete your profile first before applying!');
          window.location.href = 'profile.html';
          return;
        }

        const profileData = profileDoc.data();

        // Create application
        const applicationData = {
          uid: currentUser.uid,
          email: currentUser.email,
          programName: programName,
          programId: programId,
          applicantInfo: {
            fullName: profileData.fullName,
            firstName: profileData.firstName,
            lastName: profileData.lastName,
            birthdate: profileData.birthdate,
            gender: profileData.gender,
            phone: profileData.phone,
            barangay: profileData.barangay,
            address: profileData.address,
            householdSize: profileData.householdSize,
            monthlyIncome: profileData.monthlyIncome,
            specialNeeds: profileData.specialNeeds
          },
          status: 'pending',
          appliedAt: firebase.firestore.FieldValue.serverTimestamp(),
          reviewedAt: null,
          reviewedBy: null
        };

        await db.collection("applications").add(applicationData);
        
        alert('Application submitted successfully! Please wait for admin approval.');
        return true;
      } catch (error) {
        console.error('Error submitting application:', error);
        alert('Error submitting application: ' + error.message);
        return false;
      }
    }

    // Make submitApplication available globally
    window.submitApplication = submitApplication;

    // Logout function
    async function handleLogout() {
      if (confirm('Are you sure you want to logout?')) {
        try {
          await auth.signOut();
          window.location.href = 'login.html';
        } catch (error) {
          console.error('Logout error:', error);
          alert('Error logging out');
        }
      }
    }

    function showSuccess(message) {
      hideAllMessages();
      const successDiv = document.getElementById('successMessage');
      successDiv.textContent = message;
      successDiv.classList.add('show');
      setTimeout(() => successDiv.classList.remove('show'), 5000);
    }

    function showError(message) {
      hideAllMessages();
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = message;
      errorDiv.classList.add('show');
      setTimeout(() => errorDiv.classList.remove('show'), 5000);
    }

    function showInfo(message) {
      hideAllMessages();
      const infoDiv = document.getElementById('infoMessage');
      infoDiv.textContent = message;
      infoDiv.classList.add('show');
      setTimeout(() => infoDiv.classList.remove('show'), 3000);
    }

    function hideAllMessages() {
      document.getElementById('successMessage').classList.remove('show');
      document.getElementById('errorMessage').classList.remove('show');
      document.getElementById('infoMessage').classList.remove('show');
    }
  </script>
</body>
</html>